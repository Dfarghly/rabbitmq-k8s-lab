# ------------------------------------------------------------
# alertmanager-config-rabbitmq.yaml
# ------------------------------------------------------------
# Minimal Alertmanager configuration dedicated ONLY to RabbitMQ
# alerts, safe for lab environments and public GitHub.
#
# All webhook URLs, channels, and runbook links are placeholders.
#
# ------------------------------------------------------------

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-rabbitmq-config
  namespace: <MONITORING_NAMESPACE>     # e.g. monitoring
data:
  alertmanager.yml: |
    global: {}

    # Suppress warning alerts when a critical alert for same condition exists
    inhibit_rules:
      - equal: ["alertname"]
        source_match:
          severity: critical
        target_match:
          severity: warning

    receivers:
      # Default RabbitMQ receiver (warnings/info)
      - name: rabbitmq-monitoring
        slack_configs:
          - api_url: <SLACK_WEBHOOK_RABBITMQ>
            channel: "<SLACK_CHANNEL_RABBITMQ>"
            send_resolved: true
            text: '{{ template "slack.rabbitmq.text" . }}'
            title: '{{ template "slack.rabbitmq.title" . }}'

      # Critical alerts receiver (pages)
      - name: rabbitmq-page
        slack_configs:
          - api_url: <SLACK_WEBHOOK_RABBITMQ>
            channel: "<SLACK_CHANNEL_RABBITMQ>"
            send_resolved: true
            text: '{{ template "slack.rabbitmq.text" . }}'
            title: '{{ template "slack.rabbitmq.title" . }}'
        victorops_configs:
          - api_key: <RABBITMQ_PAGING_API_KEY>
            routing_key: <RABBITMQ_PAGING_ROUTING_KEY>
            state_message: >
              Alert: {{ .CommonLabels.alertname }}.
              Summary: {{ .CommonAnnotations.summary }}.
              RawData: {{ .CommonLabels }}

      # Test-only RabbitMQ receiver (sandbox load tests)
      - name: rabbitmq-test
        slack_configs:
          - api_url: <SLACK_WEBHOOK_RABBITMQ_TEST>
            channel: "<SLACK_CHANNEL_RABBITMQ_TEST>"
            send_resolved: true
            text: '{{ template "slack.rabbitmq.text" . }}'
            title: '{{ template "slack.rabbitmq.title" . }}'

    # ------------------------------------------------------------
    # Routing Logic (RabbitMQ ONLY)
    # ------------------------------------------------------------
    route:
      group_by: ["alertname", "service", "vhost"]
      group_interval: 5m
      group_wait: 30s
      receiver: rabbitmq-test      # default for lab/test
      repeat_interval: 3h

      routes:
        # üö® Critical RabbitMQ events ‚Üí paging channel
        - match:
            component: rabbitmq
            severity: critical
          receiver: rabbitmq-page

        # ‚ö†Ô∏è Warning-level RabbitMQ alerts ‚Üí monitoring channel
        - match:
            component: rabbitmq
            severity: warning
          receiver: rabbitmq-monitoring

        # üß™ Test alerts (matching "test" env) ‚Üí test receiver
        - match:
            env: test
            component: rabbitmq
          receiver: rabbitmq-test

        # Default: all RabbitMQ alerts ‚Üí monitoring
        - match:
            component: rabbitmq
          receiver: rabbitmq-monitoring

    templates:
      - /etc/config/rabbitmq-alerts.tmpl

  rabbitmq-alerts.tmpl: |
    {{ define "slack.rabbitmq.title" -}}
      [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]
      {{ .CommonLabels.alertname }}
    {{- end }}

    {{ define "slack.rabbitmq.text" -}}
      *Severity:* {{ .CommonLabels.severity }}
      *Component:* {{ .CommonLabels.component }}
      *Instance:* {{ .CommonLabels.instance }}
      *Description:* {{ .CommonAnnotations.description }}
      *Raw Labels:* {{ .CommonLabels }}
      *Runbook:* <{{ "<RABBITMQ_RUNBOOK_URL>" }}|View>
    {{- end }}
